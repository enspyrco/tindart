name: Screenshots

on:
  workflow_dispatch: # Manual trigger
  push:
    tags:
      - 'v*' # Run on version tags

jobs:
  screenshots-android:
    name: Android Screenshots
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK for testing
        run: flutter build apk --debug
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run Maestro Screenshots
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: pixel_6
          script: |
            adb install build/app/outputs/flutter-apk/app-debug.apk
            mkdir -p screenshots
            maestro test .maestro/screenshots.yaml

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: android-screenshots
          path: screenshots/

  screenshots-ios:
    name: iOS Screenshots
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Setup CocoaPods
        run: |
          export LANG=en_US.UTF-8
          cd ios && pod install

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Boot iOS Simulator
        run: |
          # List available simulators and boot iPhone 16 Pro Max
          xcrun simctl list devices available
          UDID=$(xcrun simctl list devices available | grep "iPhone 16 Pro Max" | head -1 | grep -oE '[0-9A-F-]{36}')
          xcrun simctl boot "$UDID" || true
          xcrun simctl list devices booted

      - name: Build and install iOS app
        run: |
          flutter build ios --debug --simulator
          xcrun simctl install booted build/ios/iphonesimulator/Runner.app

      - name: Run Maestro Screenshots
        run: |
          mkdir -p screenshots
          maestro test .maestro/screenshots.yaml

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: ios-screenshots
          path: screenshots/

  # Upload screenshots to stores (only on version tags)
  upload-to-stores:
    name: Upload to Stores
    needs: [screenshots-android, screenshots-ios]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Download Android screenshots
        uses: actions/download-artifact@v4
        with:
          name: android-screenshots
          path: fastlane/metadata/android/en-US/images/phoneScreenshots/

      - name: Download iOS screenshots
        uses: actions/download-artifact@v4
        with:
          name: ios-screenshots
          path: fastlane/screenshots/en-US/

      - name: Upload to Google Play Store
        run: bundle exec fastlane android upload_screenshots
        env:
          PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}

      - name: Upload to App Store Connect
        run: bundle exec fastlane ios upload_screenshots
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
