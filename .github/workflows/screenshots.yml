name: Screenshots

on:
  workflow_dispatch: # Manual trigger
  push:
    tags:
      - 'v*' # Run on version tags

jobs:
  screenshots-android:
    name: Android Screenshots
    runs-on: ubuntu-latest

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Build Cloud Functions
        run: |
          cd functions
          npm ci
          npm run build

      - name: Start Firebase Emulators
        run: |
          firebase emulators:start --only auth,firestore,functions &
          echo "Waiting for emulators to start..."
          sleep 15
          # Verify emulators are running
          curl -s http://localhost:9099/ || echo "Auth emulator not responding"
          curl -s http://localhost:8080/ || echo "Firestore emulator not responding"
          curl -s http://localhost:5001/ || echo "Functions emulator not responding"
          # Create test user via Auth emulator REST API and capture the response
          echo "Creating test user..."
          RESPONSE=$(curl -s -X POST "http://localhost:9099/identitytoolkit.googleapis.com/v1/accounts:signUp?key=fake-api-key" \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com","password":"testpassword123","returnSecureToken":true}')
          echo "Auth response: $RESPONSE"
          # Extract localId (user UID) from response
          USER_UID=$(echo $RESPONSE | jq -r '.localId')
          echo "User UID: $USER_UID"
          if [ -z "$USER_UID" ] || [ "$USER_UID" = "null" ]; then
            echo "ERROR: Failed to create test user!"
            exit 1
          fi
          # Mark user as having completed onboarding in users collection
          echo "Setting user as onboarded..."
          FIRESTORE_RESPONSE=$(curl -s -X PATCH "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/users/${USER_UID}" \
            -H "Content-Type: application/json" \
            -d '{"fields":{"onboarded":{"booleanValue":true},"name":{"stringValue":"Test User"}}}')
          echo "Firestore response: $FIRESTORE_RESPONSE"
          # Verify user document was created
          echo "Verifying user document..."
          curl -s "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/users/${USER_UID}"

          # Seed doc-id-lists collection (required by home screen)
          echo "Seeding doc-id-lists..."
          curl -s -X PATCH "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/doc-id-lists/RMCevRY4dGpUTTcrltun" \
            -H "Content-Type: application/json" \
            -d '{"fields":{"ids":{"arrayValue":{"values":[{"stringValue":"test-image-1"},{"stringValue":"test-image-2"},{"stringValue":"test-image-3"}]}}}}'

          # Seed image-docs collection with real images from storage
          echo "Seeding image-docs..."
          curl -s -X PATCH "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/image-docs/test-image-1" \
            -H "Content-Type: application/json" \
            -d '{"fields":{"name":{"stringValue":"FB_IMG_1721890902802.jpg"}}}'
          curl -s -X PATCH "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/image-docs/test-image-2" \
            -H "Content-Type: application/json" \
            -d '{"fields":{"name":{"stringValue":"FB_IMG_1721890902802.jpg"}}}'
          curl -s -X PATCH "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/image-docs/test-image-3" \
            -H "Content-Type: application/json" \
            -d '{"fields":{"name":{"stringValue":"FB_IMG_1721890902802.jpg"}}}'

      - name: Build APK for testing (with emulator)
        run: flutter build apk --debug --dart-define=USE_FIREBASE_EMULATOR=true
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"

      - name: Install Maestro
        run: |
          # Try installing with retries (the CDN can be flaky)
          for i in 1 2 3; do
            echo "Attempt $i to install Maestro..."
            if curl -fsSL "https://get.maestro.mobile.dev" -o maestro_install.sh && head -1 maestro_install.sh | grep -q "#!/"; then
              bash maestro_install.sh
              break
            fi
            echo "Download failed or returned HTML, retrying in 10s..."
            sleep 10
          done
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run Maestro Screenshots
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: pixel_6
          script: |
            # Verify Firebase emulators are still running
            echo "Verifying Firebase emulators..."
            curl -s http://localhost:9099/ || echo "WARNING: Auth emulator not accessible"
            curl -s http://localhost:8080/ || echo "WARNING: Firestore emulator not accessible"
            curl -s http://localhost:5001/ || echo "WARNING: Functions emulator not accessible"
            # Verify test data exists
            echo "Verifying test data..."
            curl -s "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/doc-id-lists/RMCevRY4dGpUTTcrltun"
            # Install and run
            adb install build/app/outputs/flutter-apk/app-debug.apk
            mkdir -p screenshots
            # Clear any cached Maestro state
            rm -rf ~/.maestro/tests/* 2>/dev/null || true
            # Debug: show the actual flow file being used
            echo "=== Contents of .maestro/screenshots.yaml ==="
            cat .maestro/screenshots.yaml
            echo "============================================="
            # Start capturing logcat in background for debugging
            adb logcat -c  # Clear logcat
            adb logcat > logcat.txt 2>&1 &
            LOGCAT_PID=$!
            # Launch app first to trigger sign-in
            adb shell am start -n co.enspyr.tindart/.MainActivity
            # Wait for app to initialize and sign in (with retries)
            sleep 10
            # Run Maestro tests (use full path since GITHUB_PATH isn't available in this shell)
            $HOME/.maestro/bin/maestro test .maestro/screenshots.yaml || true
            # Stop logcat and save
            kill $LOGCAT_PID || true
            # Show relevant logs
            echo "=== Flutter logs ==="
            grep -i "flutter\|ðŸ”§" logcat.txt | tail -100 || true

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-screenshots
          path: screenshots/

      - name: Upload Maestro Debug Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-maestro-debug
          path: ~/.maestro/tests/

      - name: Upload Logcat
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-logcat
          path: logcat.txt

  screenshots-ios:
    name: iOS Screenshots
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Setup CocoaPods
        run: |
          export LANG=en_US.UTF-8
          cd ios && pod install

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Build Cloud Functions
        run: |
          cd functions
          npm ci
          npm run build

      - name: Start Firebase Emulators
        run: |
          firebase emulators:start --only auth,firestore,functions &
          echo "Waiting for emulators to start..."
          sleep 15
          # Verify emulators are running
          curl -s http://localhost:9099/ || echo "Auth emulator not responding"
          curl -s http://localhost:8080/ || echo "Firestore emulator not responding"
          curl -s http://localhost:5001/ || echo "Functions emulator not responding"
          # Create test user via Auth emulator REST API and capture the response
          echo "Creating test user..."
          RESPONSE=$(curl -s -X POST "http://localhost:9099/identitytoolkit.googleapis.com/v1/accounts:signUp?key=fake-api-key" \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com","password":"testpassword123","returnSecureToken":true}')
          echo "Auth response: $RESPONSE"
          # Extract localId (user UID) from response
          USER_UID=$(echo $RESPONSE | jq -r '.localId')
          echo "User UID: $USER_UID"
          if [ -z "$USER_UID" ] || [ "$USER_UID" = "null" ]; then
            echo "ERROR: Failed to create test user!"
            exit 1
          fi
          # Mark user as having completed onboarding in users collection
          echo "Setting user as onboarded..."
          FIRESTORE_RESPONSE=$(curl -s -X PATCH "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/users/${USER_UID}" \
            -H "Content-Type: application/json" \
            -d '{"fields":{"onboarded":{"booleanValue":true},"name":{"stringValue":"Test User"}}}')
          echo "Firestore response: $FIRESTORE_RESPONSE"
          # Verify user document was created
          echo "Verifying user document..."
          curl -s "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/users/${USER_UID}"

          # Seed doc-id-lists collection (required by home screen)
          echo "Seeding doc-id-lists..."
          curl -s -X PATCH "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/doc-id-lists/RMCevRY4dGpUTTcrltun" \
            -H "Content-Type: application/json" \
            -d '{"fields":{"ids":{"arrayValue":{"values":[{"stringValue":"test-image-1"},{"stringValue":"test-image-2"},{"stringValue":"test-image-3"}]}}}}'

          # Seed image-docs collection with real images from storage
          echo "Seeding image-docs..."
          curl -s -X PATCH "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/image-docs/test-image-1" \
            -H "Content-Type: application/json" \
            -d '{"fields":{"name":{"stringValue":"FB_IMG_1721890902802.jpg"}}}'
          curl -s -X PATCH "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/image-docs/test-image-2" \
            -H "Content-Type: application/json" \
            -d '{"fields":{"name":{"stringValue":"FB_IMG_1721890902802.jpg"}}}'
          curl -s -X PATCH "http://localhost:8080/v1/projects/tindart-8c83b/databases/(default)/documents/image-docs/test-image-3" \
            -H "Content-Type: application/json" \
            -d '{"fields":{"name":{"stringValue":"FB_IMG_1721890902802.jpg"}}}'

      - name: Install Maestro
        run: |
          # Try installing with retries (the CDN can be flaky)
          for i in 1 2 3; do
            echo "Attempt $i to install Maestro..."
            if curl -fsSL "https://get.maestro.mobile.dev" -o maestro_install.sh && head -1 maestro_install.sh | grep -q "#!/"; then
              bash maestro_install.sh
              break
            fi
            echo "Download failed or returned HTML, retrying in 10s..."
            sleep 10
          done
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Boot iOS Simulator
        run: |
          # List available simulators and boot iPhone 16 Pro Max
          xcrun simctl list devices available
          UDID=$(xcrun simctl list devices available | grep "iPhone 16 Pro Max" | head -1 | grep -oE '[0-9A-F-]{36}')
          xcrun simctl boot "$UDID" || true
          xcrun simctl list devices booted

      - name: Build and install iOS app
        run: |
          flutter build ios --debug --simulator --dart-define=USE_FIREBASE_EMULATOR=true
          xcrun simctl install booted build/ios/iphonesimulator/Runner.app

      - name: Run Maestro Screenshots
        run: |
          mkdir -p screenshots
          # Clear any cached Maestro state
          rm -rf ~/.maestro/tests/* 2>/dev/null || true
          # Debug: show the actual flow file being used
          echo "=== Contents of .maestro/screenshots.yaml ==="
          cat .maestro/screenshots.yaml
          echo "============================================="
          maestro test .maestro/screenshots.yaml

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-screenshots
          path: screenshots/

      - name: Upload Maestro Debug Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-maestro-debug
          path: ~/.maestro/tests/

  # Upload screenshots to stores (only on version tags)
  upload-to-stores:
    name: Upload to Stores
    needs: [screenshots-android, screenshots-ios]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Download Android screenshots
        uses: actions/download-artifact@v4
        with:
          name: android-screenshots
          path: fastlane/metadata/android/en-US/images/phoneScreenshots/

      - name: Download iOS screenshots
        uses: actions/download-artifact@v4
        with:
          name: ios-screenshots
          path: fastlane/screenshots/en-US/

      - name: Upload to Google Play Store
        run: bundle exec fastlane android upload_screenshots
        env:
          PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}

      - name: Upload to App Store Connect
        run: bundle exec fastlane ios upload_screenshots
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          FASTLANE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
